<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<title>Example 9 (Drawing an isometric Grid using the HTML5 Canvas)</title>
		
		<link rel="stylesheet" href="ui-style.css" />
		<script src="../utils/modernizr-1.7.min.js" charset="utf-8"></script>
		<script charset="utf-8">	

			window.requestAnimFrame = (function(){
		      return  window.requestAnimationFrame       || 
		              window.webkitRequestAnimationFrame || 
		              window.mozRequestAnimationFrame    || 
		              window.oRequestAnimationFrame      || 
		              window.msRequestAnimationFrame     || 
		              function(/* function */ callback, /* DOMElement */ element) {
		              	window.setTimeout(callback, 10);
		              };
		    })();

		    var Keys = {
		    	UP: 38,
		    	DOWN: 40,
		    	LEFT: 37,
		    	RIGHT: 39,
		    	W: 81, // Wide-angle (zoom out)
		    	T: 84 // Telephoto (zoom in)
		    }

		    var TileType = {
				TERRAIN: 0,
				ICECREAMSHOP: 1,
				CINEMA: 2,
				TREE: 3

			}

			var Tools = {
				current: null,
				//current: null, // Default tool
				/* - */
				MOVE: 0,
				ZOOM_IN: 1,
				ZOOM_OUT: 2,
				LOAD: 3,
				SAVE: 4,
				BUILD: 5
			}

			var dragHelper = {
				active: false,
				x: 0,
				y: 0	
			}

			var zoomHelper = {
				level: 1,
				max: 2,
				min: 0.50,
				increase: function() { this.level += (this.level <= this.max) ? 0.05 : 0; },
				decrease: function() { this.level -= (this.level >= this.min) ? 0.05 : 0; }
			}

			var tileMap = null;

			var initGame = function() {
				var tools = document.getElementById('tools');

				var canvas = document.getElementById('myCanvas');
				var c = canvas.getContext('2d');

				var currentTile = { x: 0, j: 0 };
				var scrollPosition = { x: 0, y: 0 }

				var tile = new Image();
				tile.src = "../img/tile.png";

				var iceCreamShop = new Image();
				iceCreamShop.src = "../img/icecream.png";
				
				tools.addEventListener('click', function(e) {
					switch(e.target.getAttribute('id')) {
						case 'build':
							selectTool(Tools.BUILD, document.getElementById('build'));
							break;
						case 'move':
							selectTool(Tools.MOVE, document.getElementById('move'));
							break;
						case 'zoomIn':
							selectTool(Tools.ZOOM_IN, document.getElementById('zoomIn'));
							break;
						case 'zoomOut':
							selectTool(Tools.ZOOM_OUT, document.getElementById('zoomOut'));
							break;
					}
				}, false);

				window.addEventListener('resize', doResize, false);
				canvas.addEventListener('mousedown', handleMouseDown, false);
				canvas.addEventListener('mousemove', handleDrag, false);
				window.addEventListener('mouseup', handleMouseUp, false);
				window.addEventListener('keydown', handleKeyDown, false);

				function selectTool(tool, elem) {
					// Remove the "active" class from any element inside the div#tools ul
					for (var i = 0, x = elem.parentNode.childNodes.length; i < x; i++) {
						if (elem.parentNode.childNodes[i].tagName == "LI") {
							elem.parentNode.childNodes[i].className = null;
						}
					}

					elem.className += "active";

					switch(tool) {
						case Tools.BUILD:
							Tools.current = Tools.BUILD;
							break;
						case Tools.MOVE:
							Tools.current = Tools.MOVE;
							break;
						case Tools.ZOOM_IN:
							Tools.current = Tools.ZOOM_IN;
							break;
						case Tools.ZOOM_OUT:
							Tools.current = Tools.ZOOM_OUT;
							break;
					}
				}

				function handleKeyDown(e) {
					switch (e.keyCode) {
						case Keys.UP:
							scrollPosition.y += 20;
							break;
						case Keys.DOWN:
							scrollPosition.y -= 20;
							break;
						case Keys.LEFT:
							scrollPosition.x += 20;
							break;
						case Keys.RIGHT:
							scrollPosition.x -= 20;
							break;
						case Keys.W:
							zoomHelper.decrease();
							break;
						case Keys.T:
							zoomHelper.increase();
							break;
					}
				}

				function handleMouseDown(e) {
					switch (Tools.current) {
						case Tools.BUILD:
							



                            var x = e.clientX;
							var y = e.clientY;
							var mapY = (tileMap[0].length * zoomHelper.level) + scrollPosition.y;

							var mapX = (tileMap.length * zoomHelper.level);
							mapX += (canvas.width / 2) - ((tile.width / 2) * zoomHelper.level) + scrollPosition.x;

							var ymouse=(2*(y-mapY)-x+mapX)/2;
							var xmouse=x+ymouse-mapX-tile.height;
					 		
					 		ymouse=Math.round(ymouse/tile.height);
							xmouse=Math.round(xmouse/tile.height);
							//document.title = "tileY:" + ymouse + " | tileX:" + xmouse;
                            //console.log(xmouse + ' ' + ymouse);
                            tileMap[xmouse][ymouse] = TileType.ICECREAMSHOP;

                            //console.log(tileMap[xmouse][ymouse]);

							break;
						case Tools.MOVE:
							dragHelper.active = true;
							dragHelper.x = e.clientX;
							dragHelper.y = e.clientY;
							break;
						case Tools.ZOOM_IN:
							zoomHelper.increase();
							break;
						case Tools.ZOOM_OUT:
							zoomHelper.decrease();
							break;
					}
				}

				function handleDrag(e) {
					switch (Tools.current) {
						case Tools.MOVE:
							if (dragHelper.active) {
								scrollPosition.x -= (dragHelper.x - e.clientX) / 18;
								scrollPosition.y -= (dragHelper.y - e.clientY) / 18;
							}
							break;
					}
				}

				function handleMouseUp(e) {
					switch (Tools.current) {
						case Tools.MOVE:
							dragHelper.active = false;
							break;
					}
				}

				function doResize() {
					canvas.width = document.body.clientWidth;
					canvas.height = document.body.clientHeight;
				}

				function initializeGrid() {
					// 100 x 100 grid
					tileMap = new Array(100);
					for (var i = 0, x = tileMap.length; i < x; i++) {
						tileMap[i] = new Array(100);
						for (var j = 0, r = tileMap[i].length; j < r; j++) {
							tileMap[i][j] = 0;
						}
					}
				}
				
				function drawGrid() {
					
					tile.width = 128 * zoomHelper.level;
					tile.height = 64 * zoomHelper.level;

					iceCreamShop.width = 128 * zoomHelper.level;
					iceCreamShop.height = 110 * zoomHelper.level;

					c.clearRect (0, 0, canvas.width, canvas.height);
					c.fillStyle = '#0C3B00';
					c.fillRect (0, 0, canvas.width, canvas.height);

					for (var i = 0, tileMapX = tileMap.length; i < tileMapX; i++) {
						for (var j = 0, tileMapY = tileMap[0].length; j < tileMapY; j++) {
							var xpos = (i-j) * tile.height + (tileMapX * zoomHelper.level);
							xpos += (canvas.width / 2) - ((tile.width / 2) * zoomHelper.level) + scrollPosition.x;

							var ypos = (i + j) * ((tile.height/2)) + (tileMapY * zoomHelper.level) + scrollPosition.y;

							switch (tileMap[i][j]) {
								case TileType.TERRAIN:
									// Only draw what we can see
									if (((xpos + tile.width) > 0 && xpos < canvas.width) &&
										((ypos + tile.height) > 0 && ypos < canvas.height)) {

										// Round the result of xpos and ypos to avoid artifacts, no-one likes half-pixels.
										c.drawImage(tile, Math.round(xpos), Math.round(ypos), tile.width, tile.height);	
									}
									break;
								case TileType.ICECREAMSHOP:
									ypos -= iceCreamShop.height - tile.height;
									c.drawImage(iceCreamShop, Math.round(xpos), Math.round(ypos), iceCreamShop.width, iceCreamShop.height);
									break;
							}

						}	
					}

					requestAnimFrame(drawGrid);
				}

				initializeGrid();
				doResize();
				requestAnimFrame(drawGrid);
			}

			window.onload = function () {
				var missingDeps = [];
				var dependencies = [Modernizr.rgba, 
									Modernizr.canvas,
									Modernizr.borderradius,
									Modernizr.boxshadow,
									Modernizr.cssgradients];

				for (var i = 0, dep = dependencies.length; i < dep; i++) {
					if (!dependencies[i]) {
						missingDeps.push(dependencies[i]);
					}
				}

				if (missingDeps.length == 0) {
					initGame();
				} else {
					alert("Your browser doesn't include support for some of the technologies required to play this game.");
				}
			}
		</script>
    </head>
    <body>
		<canvas id="myCanvas" width="1" height="1"></canvas>
		<div id="ui">
			<div id="tools">
				<ul>
					<li id="build"></li>
					<li id="move"></li>
					<li id="zoomIn"></li>
					<li id="zoomOut"></li>
				</ul>
			</div>
		</div>
    </body>
</html>